-- ============================================
-- BITSY CRM - COMPLETE DATABASE SCHEMA
-- Run this ENTIRE file in Supabase SQL Editor
-- This includes: Base tables, Enhanced features, Super Admin, Permissions
-- ============================================

-- Organizations Table
CREATE TABLE IF NOT EXISTS organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    plan TEXT NOT NULL CHECK (plan IN ('starter', 'professional')),
    max_users INTEGER NOT NULL,
    max_customers INTEGER NOT NULL,
    stripe_customer_id TEXT,
    stripe_subscription_id TEXT,
    subscription_status TEXT DEFAULT 'trial',
    trial_ends_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '14 days'),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Customers Table
CREATE TABLE IF NOT EXISTS customers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    email TEXT,
    phone TEXT,
    address TEXT,
    notes TEXT,
    tags TEXT[],
    custom_fields JSONB DEFAULT '{}',
    status TEXT DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Jobs Table
CREATE TABLE IF NOT EXISTS jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled')),
    priority TEXT DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high', 'urgent')),
    assigned_to UUID REFERENCES auth.users(id),
    value DECIMAL(10, 2) DEFAULT 0,
    scheduled_date TIMESTAMP WITH TIME ZONE,
    completed_date TIMESTAMP WITH TIME ZONE,
    tags TEXT[],
    custom_fields JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Team Members Table
CREATE TABLE IF NOT EXISTS team_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    role TEXT DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'manager', 'employee', 'viewer')),
    email TEXT NOT NULL,
    name TEXT,
    status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'invited')),
    permissions JSONB DEFAULT '{
        "view_customers": true,
        "edit_customers": false,
        "delete_customers": false,
        "view_jobs": true,
        "edit_jobs": false,
        "delete_jobs": false,
        "view_transactions": true,
        "edit_transactions": false,
        "manage_team": false,
        "view_reports": true,
        "add_notes": true
    }',
    invited_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    joined_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(organization_id, user_id)
);

-- Customer Notes Table
CREATE TABLE IF NOT EXISTS customer_notes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
    created_by UUID REFERENCES auth.users(id),
    note_text TEXT NOT NULL,
    is_pinned BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Transactions Table
CREATE TABLE IF NOT EXISTS transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
    job_id UUID REFERENCES jobs(id) ON DELETE SET NULL,
    created_by UUID REFERENCES auth.users(id),
    transaction_type TEXT NOT NULL CHECK (transaction_type IN ('invoice', 'payment', 'estimate', 'refund', 'expense')),
    amount DECIMAL(10, 2) NOT NULL,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'paid', 'overdue', 'cancelled')),
    description TEXT,
    invoice_number TEXT,
    due_date TIMESTAMP WITH TIME ZONE,
    paid_date TIMESTAMP WITH TIME ZONE,
    payment_method TEXT,
    notes TEXT,
    attachments JSONB DEFAULT '[]',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Activity Log Table
CREATE TABLE IF NOT EXISTS activity_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id),
    entity_type TEXT NOT NULL,
    entity_id UUID NOT NULL,
    action TEXT NOT NULL,
    changes JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Admin Users Table
CREATE TABLE IF NOT EXISTS admin_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
    email TEXT NOT NULL UNIQUE,
    role TEXT NOT NULL DEFAULT 'super_admin' CHECK (role IN ('super_admin', 'support')),
    permissions JSONB DEFAULT '{"view_all": true, "edit_all": true, "delete_all": true, "manage_admins": true}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by UUID REFERENCES auth.users(id),
    last_login TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT true
);

-- Admin Activity Log
CREATE TABLE IF NOT EXISTS admin_activity_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    admin_user_id UUID REFERENCES admin_users(id) ON DELETE SET NULL,
    action TEXT NOT NULL,
    target_type TEXT,
    target_id UUID,
    details JSONB,
    ip_address TEXT,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================
-- ENABLE ROW LEVEL SECURITY
-- ============================================

ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE jobs ENABLE ROW LEVEL SECURITY;
ALTER TABLE team_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE customer_notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE activity_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE admin_users ENABLE ROW LEVEL SECURITY;
ALTER TABLE admin_activity_log ENABLE ROW LEVEL SECURITY;

-- ============================================
-- HELPER FUNCTIONS
-- ============================================

-- Function to check if user is admin
CREATE OR REPLACE FUNCTION is_admin(check_user_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1 FROM admin_users
        WHERE user_id = check_user_id AND is_active = true
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to check if user is super admin
CREATE OR REPLACE FUNCTION is_super_admin(check_user_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1 FROM admin_users
        WHERE user_id = check_user_id 
        AND role = 'super_admin' 
        AND is_active = true
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to make a user super admin
CREATE OR REPLACE FUNCTION make_super_admin(user_email TEXT)
RETURNS TEXT AS $$
DECLARE
    v_user_id UUID;
BEGIN
    SELECT id INTO v_user_id FROM auth.users WHERE email = user_email;
    
    IF v_user_id IS NULL THEN
        RETURN 'ERROR: User not found with email: ' || user_email;
    END IF;
    
    INSERT INTO admin_users (user_id, email, role, created_by)
    VALUES (v_user_id, user_email, 'super_admin', v_user_id)
    ON CONFLICT (user_id) 
    DO UPDATE SET role = 'super_admin', is_active = true;
    
    RETURN 'SUCCESS: User ' || user_email || ' is now a super admin!';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to get role permissions
CREATE OR REPLACE FUNCTION get_role_permissions(role_name TEXT)
RETURNS JSONB AS $$
BEGIN
    RETURN CASE role_name
        WHEN 'owner' THEN '{
            "view_customers": true,
            "edit_customers": true,
            "delete_customers": true,
            "view_jobs": true,
            "edit_jobs": true,
            "delete_jobs": true,
            "view_transactions": true,
            "edit_transactions": true,
            "manage_team": true,
            "view_reports": true,
            "add_notes": true
        }'::jsonb
        WHEN 'admin' THEN '{
            "view_customers": true,
            "edit_customers": true,
            "delete_customers": true,
            "view_jobs": true,
            "edit_jobs": true,
            "delete_jobs": true,
            "view_transactions": true,
            "edit_transactions": true,
            "manage_team": false,
            "view_reports": true,
            "add_notes": true
        }'::jsonb
        WHEN 'manager' THEN '{
            "view_customers": true,
            "edit_customers": true,
            "delete_customers": false,
            "view_jobs": true,
            "edit_jobs": true,
            "delete_jobs": false,
            "view_transactions": true,
            "edit_transactions": true,
            "manage_team": false,
            "view_reports": true,
            "add_notes": true
        }'::jsonb
        WHEN 'employee' THEN '{
            "view_customers": true,
            "edit_customers": false,
            "delete_customers": false,
            "view_jobs": true,
            "edit_jobs": true,
            "delete_jobs": false,
            "view_transactions": true,
            "edit_transactions": false,
            "manage_team": false,
            "view_reports": false,
            "add_notes": true
        }'::jsonb
        WHEN 'viewer' THEN '{
            "view_customers": true,
            "edit_customers": false,
            "delete_customers": false,
            "view_jobs": true,
            "edit_jobs": false,
            "delete_jobs": false,
            "view_transactions": true,
            "edit_transactions": false,
            "manage_team": false,
            "view_reports": false,
            "add_notes": true
        }'::jsonb
        ELSE '{
            "view_customers": true,
            "edit_customers": false,
            "delete_customers": false,
            "view_jobs": true,
            "edit_jobs": false,
            "delete_jobs": false,
            "view_transactions": false,
            "edit_transactions": false,
            "manage_team": false,
            "view_reports": false,
            "add_notes": false
        }'::jsonb
    END;
END;
$$ LANGUAGE plpgsql;

-- Function to create organization on user signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER 
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
    v_org_name TEXT;
    v_plan TEXT;
    v_max_users INTEGER;
    v_max_customers INTEGER;
BEGIN
    v_org_name := COALESCE(NEW.raw_user_meta_data->>'organization_name', 'My Business');
    v_plan := COALESCE(NEW.raw_user_meta_data->>'plan', 'starter');
    
    IF v_plan = 'professional' THEN
        v_max_users := 10;
        v_max_customers := 500;
    ELSE
        v_max_users := 5;
        v_max_customers := 250;
    END IF;
    
    INSERT INTO public.organizations (
        owner_id, name, plan, max_users, max_customers, subscription_status, trial_ends_at
    )
    VALUES (
        NEW.id, v_org_name, v_plan, v_max_users, v_max_customers, 'trial', NOW() + INTERVAL '14 days'
    );
    
    RAISE NOTICE 'Organization created for user %', NEW.email;
    RETURN NEW;
    
EXCEPTION WHEN OTHERS THEN
    RAISE WARNING 'Failed to create organization for user %: %', NEW.email, SQLERRM;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function to log customer changes
CREATE OR REPLACE FUNCTION log_customer_change()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'UPDATE' THEN
        INSERT INTO activity_log (organization_id, user_id, entity_type, entity_id, action, changes)
        VALUES (NEW.organization_id, auth.uid(), 'customer', NEW.id, 'updated',
                jsonb_build_object('old', to_jsonb(OLD), 'new', to_jsonb(NEW)));
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO activity_log (organization_id, user_id, entity_type, entity_id, action, changes)
        VALUES (OLD.organization_id, auth.uid(), 'customer', OLD.id, 'deleted', to_jsonb(OLD));
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Update updated_at column
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- CREATE TRIGGERS
-- ============================================

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

DROP TRIGGER IF EXISTS log_customer_changes ON customers;
CREATE TRIGGER log_customer_changes
    AFTER UPDATE OR DELETE ON customers
    FOR EACH ROW EXECUTE FUNCTION log_customer_change();

CREATE TRIGGER update_organizations_updated_at BEFORE UPDATE ON organizations
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_customers_updated_at BEFORE UPDATE ON customers
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_jobs_updated_at BEFORE UPDATE ON jobs
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_customer_notes_updated_at BEFORE UPDATE ON customer_notes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_transactions_updated_at BEFORE UPDATE ON transactions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- ROW LEVEL SECURITY POLICIES
-- ============================================

-- Organizations Policies
DROP POLICY IF EXISTS "Users can view their own organization or admins view all" ON organizations;
CREATE POLICY "Users can view their own organization or admins view all"
    ON organizations FOR SELECT USING (auth.uid() = owner_id OR is_admin(auth.uid()));

DROP POLICY IF EXISTS "Users can update their own organization or admins update all" ON organizations;
CREATE POLICY "Users can update their own organization or admins update all"
    ON organizations FOR UPDATE USING (auth.uid() = owner_id OR is_admin(auth.uid()));

DROP POLICY IF EXISTS "Users can insert their own organization" ON organizations;
CREATE POLICY "Users can insert their own organization"
    ON organizations FOR INSERT WITH CHECK (auth.uid() = owner_id OR is_admin(auth.uid()));

DROP POLICY IF EXISTS "Super admins can delete organizations" ON organizations;
CREATE POLICY "Super admins can delete organizations"
    ON organizations FOR DELETE USING (is_super_admin(auth.uid()));

-- Customers Policies
DROP POLICY IF EXISTS "Users can view customers in their organization" ON customers;
CREATE POLICY "Users can view customers in their organization"
    ON customers FOR SELECT USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

DROP POLICY IF EXISTS "Users can insert customers in their organization" ON customers;
CREATE POLICY "Users can insert customers in their organization"
    ON customers FOR INSERT WITH CHECK (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid())
    );

DROP POLICY IF EXISTS "Users can update customers in their organization" ON customers;
CREATE POLICY "Users can update customers in their organization"
    ON customers FOR UPDATE USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

DROP POLICY IF EXISTS "Users can delete customers in their organization" ON customers;
CREATE POLICY "Users can delete customers in their organization"
    ON customers FOR DELETE USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

-- Jobs Policies (same pattern as customers)
DROP POLICY IF EXISTS "Users can view jobs in their organization" ON jobs;
CREATE POLICY "Users can view jobs in their organization"
    ON jobs FOR SELECT USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

DROP POLICY IF EXISTS "Users can insert jobs" ON jobs;
CREATE POLICY "Users can insert jobs"
    ON jobs FOR INSERT WITH CHECK (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid())
    );

DROP POLICY IF EXISTS "Users can update jobs" ON jobs;
CREATE POLICY "Users can update jobs"
    ON jobs FOR UPDATE USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

DROP POLICY IF EXISTS "Users can delete jobs" ON jobs;
CREATE POLICY "Users can delete jobs"
    ON jobs FOR DELETE USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

-- Team Members Policies
DROP POLICY IF EXISTS "Users can view team members" ON team_members;
CREATE POLICY "Users can view team members"
    ON team_members FOR SELECT USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

DROP POLICY IF EXISTS "Users can manage team members" ON team_members;
CREATE POLICY "Users can manage team members"
    ON team_members FOR ALL USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

-- Customer Notes Policies
DROP POLICY IF EXISTS "Users can view notes" ON customer_notes;
CREATE POLICY "Users can view notes"
    ON customer_notes FOR SELECT USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

DROP POLICY IF EXISTS "Users can create notes" ON customer_notes;
CREATE POLICY "Users can create notes"
    ON customer_notes FOR INSERT WITH CHECK (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid())
    );

DROP POLICY IF EXISTS "Users can update notes" ON customer_notes;
CREATE POLICY "Users can update notes"
    ON customer_notes FOR UPDATE USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid())
    );

DROP POLICY IF EXISTS "Users can delete notes" ON customer_notes;
CREATE POLICY "Users can delete notes"
    ON customer_notes FOR DELETE USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid())
    );

-- Transactions Policies
DROP POLICY IF EXISTS "Users can view transactions" ON transactions;
CREATE POLICY "Users can view transactions"
    ON transactions FOR SELECT USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

DROP POLICY IF EXISTS "Users can create transactions" ON transactions;
CREATE POLICY "Users can create transactions"
    ON transactions FOR INSERT WITH CHECK (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid())
    );

DROP POLICY IF EXISTS "Users can update transactions" ON transactions;
CREATE POLICY "Users can update transactions"
    ON transactions FOR UPDATE USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid())
    );

DROP POLICY IF EXISTS "Users can delete transactions" ON transactions;
CREATE POLICY "Users can delete transactions"
    ON transactions FOR DELETE USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid())
    );

-- Activity Log Policies
DROP POLICY IF EXISTS "Users can view activity log" ON activity_log;
CREATE POLICY "Users can view activity log"
    ON activity_log FOR SELECT USING (
        organization_id IN (SELECT id FROM organizations WHERE owner_id = auth.uid()) OR is_admin(auth.uid())
    );

-- Admin Users Policies
DROP POLICY IF EXISTS "Admins can view admin users" ON admin_users;
CREATE POLICY "Admins can view admin users"
    ON admin_users FOR SELECT USING (is_admin(auth.uid()));

DROP POLICY IF EXISTS "Super admins can manage admins" ON admin_users;
CREATE POLICY "Super admins can manage admins"
    ON admin_users FOR ALL USING (is_super_admin(auth.uid()));

-- Admin Activity Log Policies
DROP POLICY IF EXISTS "Admins can view admin activity" ON admin_activity_log;
CREATE POLICY "Admins can view admin activity"
    ON admin_activity_log FOR SELECT USING (is_admin(auth.uid()));

-- ============================================
-- CREATE INDEXES
-- ============================================

CREATE INDEX IF NOT EXISTS idx_customers_organization_id ON customers(organization_id);
CREATE INDEX IF NOT EXISTS idx_customers_email ON customers(email);
CREATE INDEX IF NOT EXISTS idx_customers_status ON customers(status);

CREATE INDEX IF NOT EXISTS idx_jobs_organization_id ON jobs(organization_id);
CREATE INDEX IF NOT EXISTS idx_jobs_customer_id ON jobs(customer_id);
CREATE INDEX IF NOT EXISTS idx_jobs_status ON jobs(status);
CREATE INDEX IF NOT EXISTS idx_jobs_assigned_to ON jobs(assigned_to);

CREATE INDEX IF NOT EXISTS idx_team_members_organization_id ON team_members(organization_id);
CREATE INDEX IF NOT EXISTS idx_team_members_user_id ON team_members(user_id);

CREATE INDEX IF NOT EXISTS idx_customer_notes_customer_id ON customer_notes(customer_id);
CREATE INDEX IF NOT EXISTS idx_customer_notes_organization_id ON customer_notes(organization_id);

CREATE INDEX IF NOT EXISTS idx_transactions_customer_id ON transactions(customer_id);
CREATE INDEX IF NOT EXISTS idx_transactions_organization_id ON transactions(organization_id);
CREATE INDEX IF NOT EXISTS idx_transactions_status ON transactions(status);

CREATE INDEX IF NOT EXISTS idx_activity_log_organization_id ON activity_log(organization_id);
CREATE INDEX IF NOT EXISTS idx_admin_users_user_id ON admin_users(user_id);
CREATE INDEX IF NOT EXISTS idx_admin_users_email ON admin_users(email);

-- ============================================
-- GRANT PERMISSIONS
-- ============================================

GRANT USAGE ON SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO anon, authenticated;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO anon, authenticated;

-- ============================================
-- SUCCESS MESSAGE
-- ============================================

DO $$
BEGIN
    RAISE NOTICE '========================================';
    RAISE NOTICE 'âœ… BITSY CRM DATABASE SETUP COMPLETE!';
    RAISE NOTICE '========================================';
    RAISE NOTICE '';
    RAISE NOTICE 'Features installed:';
    RAISE NOTICE '- Base CRM (Organizations, Customers, Jobs)';
    RAISE NOTICE '- Customer Notes with timestamps';
    RAISE NOTICE '- Transaction Tracking (invoices, payments)';
    RAISE NOTICE '- Team Member Management with permissions';
    RAISE NOTICE '- Super Admin System';
    RAISE NOTICE '- Activity Logging';
    RAISE NOTICE '';
    RAISE NOTICE 'Next steps:';
    RAISE NOTICE '1. Create your account in the app';
    RAISE NOTICE '2. Run: SELECT make_super_admin(''your@email.com'');';
    RAISE NOTICE '3. Start using Bitsy CRM!';
    RAISE NOTICE '';
    RAISE NOTICE '========================================';
END $$;
